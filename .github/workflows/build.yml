name: Build SuperFlix (Clean)

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. CHECKOUT (silencioso)
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 2. BUILD (apenas erros)
      - name: Compilar plugin
        run: |
          echo "ðŸ”¨ Compilando..."
          chmod +x gradlew
          
          # Build com output filtrado
          ./gradlew :SuperFlix:assembleDebug \
            --no-daemon \
            --quiet \
            2>&1 | tee /tmp/build.log
          
          # Verifica se passou ou falhou
          if grep -q "BUILD SUCCESSFUL" /tmp/build.log; then
            echo "âœ… Build bem-sucedido"
            
            # Encontra o .cs3
            CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
            if [ -f "$CS3_FILE" ]; then
              echo "ðŸ“¦ Plugin: $(basename "$CS3_FILE")"
              echo "ðŸ“ Tamanho: $(ls -lh "$CS3_FILE" | awk '{print $5}')"
            fi
          else
            echo "âŒ Build falhou!"
            echo "=== ERROS ==="
            grep -E "error:|FAILURE|exception|âœ—|âŒ|^e: " /tmp/build.log | head -15
            exit 1
          fi
          
      # 3. CRIAR ARQUIVOS (silencioso)
      - name: Criar arquivos
        if: success()
        run: |
          mkdir -p dist
          
          # Copia .cs3
          CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
          cp "$CS3_FILE" "dist/SuperFlix.cs3"
          
          # JSONs mÃ­nimos
          echo '{"name":"SuperFlix Repo","pluginLists":["https://raw.githubusercontent.com/'${{ github.repository }}'/main/dist/plugins.json"]}' > dist/repo.json
          echo '[{"name":"SuperFlix","url":"https://raw.githubusercontent.com/'${{ github.repository }}'/main/dist/SuperFlix.cs3"}]' > dist/plugins.json
          
      # 4. COMMIT (silencioso)
      - name: Commitar
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add dist/
          git commit -m "ðŸ“¦ $(date +'%H:%M')" -q
          git push -q
          
      # 5. RESULTADO (apenas sucesso)
      - name: Resultado
        if: success()
        run: |
          echo ""
          echo "ðŸŽ‰ BUILD COMPLETO!"
          echo ""
          echo "ðŸ”— URL DO PLUGIN:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/dist/SuperFlix.cs3"
          echo ""
          echo "ðŸ“± Para instalar:"
          echo "CloudStream â†’ ConfiguraÃ§Ãµes â†’ ExtensÃµes â†’ Instalar de URL"
