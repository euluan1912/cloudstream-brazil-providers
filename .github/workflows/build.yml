name: Build SuperFlix com Proxy

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: "-Dorg.gradle.console=plain"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Configurar com Proxy
        run: |
          # Remove qualquer Config.kt antigo
          rm -f SuperFlix/src/main/kotlin/com/SuperFlix/Config.kt 2>/dev/null || true
          
          echo "âœ… ConfiguraÃ§Ã£o: Usando proxy Cloudflare Worker"
          echo "ðŸ”— URL: https://lawliet.euluan1912.workers.dev"
          
      - name: Compilar SuperFlix
        run: |
          echo "ðŸ”„ Compilando..."
          
          # Build com output mÃ­nimo
          set +e
          ./gradlew :SuperFlix:assembleDebug \
            --no-build-cache \
            --no-daemon \
            --console=plain \
            --quiet \
            > build_output.log 2>&1
          
          BUILD_STATUS=$?
          
          # Mostra apenas erros
          if [ $BUILD_STATUS -ne 0 ]; then
            echo "âŒ ERROS ENCONTRADOS:"
            echo "======================"
            grep -E "error:|FAILURE|exception|^e: |âœ—|âŒ" build_output.log | head -20
            echo ""
            echo "ðŸ” Ãšltimas 10 linhas:"
            tail -10 build_output.log
            exit 1
          else
            echo "âœ… Build bem-sucedido"
            
            # Mostra arquivo gerado
            CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
            if [ -f "$CS3_FILE" ]; then
              echo ""
              echo "ðŸŽ‰ PLUGIN GERADO:"
              echo "   Nome: $(basename "$CS3_FILE")"
              echo "   Tamanho: $(ls -lh "$CS3_FILE" | awk '{print $5}')"
              echo "   Local: $CS3_FILE"
              
              # VerificaÃ§Ã£o rÃ¡pida
              echo ""
              echo "ðŸ” VerificaÃ§Ã£o:"
              if strings "$CS3_FILE" | grep -q "superflix\|SuperFlix" 2>/dev/null; then
                echo "   âœ“ ContÃ©m 'SuperFlix'"
              fi
            fi
          fi
          
          # Limpa log
          rm -f build_output.log
